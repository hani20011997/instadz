name: Build APK with Buildozer

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python & Buildozer
      run: |
        sudo apt update
        sudo apt install -y zip unzip openjdk-17-jdk python3-pip autoconf libtool pkg-config wget tar
        pip install --upgrade pip setuptools wheel
        pip install --user Cython virtualenv buildozer
        export PATH=$HOME/.local/bin:$PATH

    - name: Install Android command-line tools
      run: |
        mkdir -p $HOME/android-sdk/cmdline-tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip \
          -O cmdline-tools.zip
        unzip cmdline-tools.zip -d $HOME/android-sdk/cmdline-tools
        mv $HOME/android-sdk/cmdline-tools/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk --licenses

    - name: Install platform & build-tools 30.0.3
      run: |
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --sdk_root=$HOME/android-sdk \
          "platform-tools" "platforms;android-30" "build-tools;30.0.3"
        echo "Installed build-tools:" 
        ls -1 $HOME/android-sdk/build-tools/30.0.3

    - name: Configure buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = MyApp
        package.name = myapp
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 0.1
        requirements = python3,kivy
        orientation = portrait
        fullscreen = 1

        [buildozer]
        log_level = 2
        warn_on_root = 0
        android.sdk_path = $HOME/android-sdk
        android.build_tools_version = 30.0.3
        EOF

    - name: Build APK
      run: |
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@master
      with:
        name: myapp-release
        path: bin/*.apk
